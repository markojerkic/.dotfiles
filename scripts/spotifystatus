#!/usr/bin/env bash

status=$(spotifycli --status 2>/dev/null | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
arturl=$(spotifycli --arturl 2>/dev/null)

average_color=""
if [[ -n "$status" ]]; then
    average_color=$(convert "$arturl" -scale 1x1\! -format '%[pixel:u]' info:- 2>/dev/null \
        | sed -e 's/srgb(\([0-9.]*\)%,\([0-9.]*\)%,\([0-9.]*\)%)/\1 \2 \3/' \
        | awk '{printf "#%02x%02x%02x\n", $1*2.55, $2*2.55, $3*2.55}' 2>/dev/null)
fi

if [[ -z "$average_color" ]]; then
    average_color="#a6e3a1" # Default fallback color
fi

r=$((16#${average_color:1:2}))
g=$((16#${average_color:3:2}))
b=$((16#${average_color:5:2}))

brightness=$(( (r * 299 + g * 587 + b * 114) / 1000 ))
playback_status=$(spotifycli --playbackstatus 2>/dev/null)

if [[ $brightness -lt 80 ]]; then
    light_r=$(( r + (255 - r) * 80 / 100 ))
    light_g=$(( g + (255 - g) * 80 / 100 ))
    light_b=$(( b + (255 - b) * 80 / 100 ))
    bg_color=$(printf "#%02x%02x%02x" $light_r $light_g $light_b)
    echo "<span foreground=\"$average_color\" background=\"$bg_color\">  $playback_status $status</span>"
else
    echo "<span color=\"$average_color\">  $playback_status $status</span>"
fi
